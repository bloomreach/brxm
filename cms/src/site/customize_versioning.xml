<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE document PUBLIC
  "-//Apache Software Foundation//DTD XDOC 1.0//EN"
  "http://maven.apache.org/dtd/xdoc_1_0.dtd">
<!--
  Copyright 2008 Hippo

  Licensed under the Apache License, Version 2.0 (the  "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS"
  BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<document>
    <properties>
        <title>Customize versioning</title>
    </properties>
    <body>
        <section name="Customize versioning">
      <span class='shortdesc'>How to customize at what events copies are made, in a custom workflow.</span>

<p>
Certain events may trigger a copy of the then current document to be made.
This copy is read-only and stored in a different section.  Additional
information, such as the date the copy was made helps keeping a time-line of
the document over time.  These copies over time are called "versions" of the
document.
</p>

<subsection name="Creating versions">

<p>
Versioning is a core functionality of the repository.  It is by default
available, there is no configuration to be modified, nor does it need to be
enabled for documents.  This does however not mean that versioning is
automatic.  The event on which a version must be created of a document is not
a core function.
</p>

<p>
It is up to the logic of the custom workflow to determine whether or not a
version has to be created of a document.  The reviewed-actions workflow plug-in
has the following logic at this time: whenever a document is published a
version of that document variant (i.e. the published document) is created.
Depublication also involves the versioning to indicate no version of the
published document available.
</p>

</subsection>

<subsection name="About the user perspective">

<p>
Users are normally not directly confronted with versioning.  Creating versions
is automatic as defined by workflow steps.  For instance, as a side effect
of the reviewed-actions workflow when publishing a document, a version of the
document is created.  This is transparent, and not unnoticeable for users.
</p>

<p>
Whether or not to create a version, needs to be part of the business model,
thus part of the workflow.
</p>


<p>
 See <a href='../../user/contributors/howto/todo/browsing_history_of_document.html'>User browsing the history of a document</a>.

This happens for the reviewed-actions workflow.  Upon publication of a
document a version of the then current published document is created.  However,
if the document is depublished, there is no longer a published version of the
document.  The ability of the Hippo ECM suite is to be able to deal with this
and indicate that in that point in history there is no version.  This
supersedes plain versioning in JCR.  Hippo does however use plain versioning,
so other clients not using plain JCR are able to use the same functionality,
albeit with less user intuitiveness.
</p>


</subsection>

<subsection name="Versioning invocation as part of a workflow step">

<p>
Although the JCR interface for versioning can be used, the main usage
interface for versioning is part of a workflow step.  It is the logic of
(custom) workflows to determine when a version of a document must be checked
in.  Workflows are written as plain Java code, as explained in X.  When such a
custom workflow is invoked it may indicate that a version must be created of a
document by in its turn invoking the internal workflow for versioning.  This
versioning workflow is a built-in workflow that has no direct representation
in a CMS front-end, but is meant to be used from within another workflow.
</p>

<p>
Suppose you have the following workflow implementation that marks a document
as "verified":
</p>

<source>
  public class VerifyWorkflowImpl extends WorkflowImpl implements VerifyWorkflow {
    VerifyableDocument theDocument;
    public void verified() {
      theDocument.verified = true;
    }
  }
</source>

<p>
Which comes with the interface for remote access and the implementation of the
document, similar as described in X.<br/>
Then you can modify this workflow to invoke the workflow to create a version
upon verification as such:
</p>

<source>
  import org.hippoecm.repository.standardworkflow.VersionWorkflow;
  public class VerifyWorkflowImpl extends WorkflowImpl implements VerifyWorkflow {
    VerifyableDocument theDocument;
    public void verified() {
      theDocument.verified = true;
      VersionWorkflow workflow = (VersionWorkflow) getWorkflowContext().getWorkflow("versioning");
      workflow.version(); // this commits the current document as a version
    }
  }
</source>

<p>
This shows the ability for workflow steps to invoke other workflows.  This
chaining of workflow steps, although looking very similar to plain method
calls, is slightly different.  Instead of invoking the workflow step directly,
it schedules the called workflow to be executed directly after the current
workflow and within the same transaction.  This means that it is not possible
to use the return values.
</p>

<p>
The versioning workflow is available on any document (it is based upon the JCR
type hippo:document) in the category "versioning".
</p>

<p>
The API of the versioning workflow is available in the Javadocs.
</p>

<p>
All packaged products of Hippo ECM have at this time versioning workflow
pre-configured in the category "versioning".  Versioning is a core function of
the repository and not a separate plug-in.  Versioning is however part of a
workflow configuration, in order for custom workflows to decide when a version
of a document needs to be checked in (i.e. created).  The following
</p>

<source>
[repository root]
`-- hippo:configuration
    `-- hippo:workflow
        `-- versioning [hippo:workflowcategory]
            |-- version [hippo:workflow]
            |   + hippo:display = Versioning workflow
            |   + hippo:classname = org.hippoecm.repository.api.Document
            |   + hippo:workflow = org.hippoecm.repository.standardworkflow.VersionWorkflowImpl
            |   + hippo:nodetype = hippo:document
            |   `-- hippo:types [hippo:types]
            |       `-- org.hippoecm.repository.api.Document [hippo:type]
            |           + hippo:classname = org.hippoecm.repository.api.Document
            |           + hippo:display = Document
            |           + hippo:nodetype = hippo:document
            `-- revert [hippo:workflow]
                + hippo:display = Versioning workflow
                + hippo:classname = org.hippoecm.repository.api.Document
                + hippo:workflow = org.hippoecm.repository.standardworkflow.VersionWorkflowImpl
                + hippo:nodetype = nt:frozenNode
                `-- hippo:types [hippo:types]
                    `-- org.hippoecm.repository.api.Document [hippo:type]
                        + hippo:classname = org.hippoecm.repository.api.Document
                        + hippo:display = Document
                        + hippo:nodetype = hippo:document
</source>

<p>
Note that this definition is already present, this description is for
informational purposes.
</p>

</subsection>

<subsection name="Expert information">

<p>
Version storage much be enabled for versions of a document to be stored.  This
is enabled by default.  This does however imply that even though versioning is
not used at all, some information is stored in the version storage.  If you
have a custom deployment, your version storage might be removed.  When
versioning does not seem to work, it needs to be verified if the version storage
is present and active.
</p>

<p>
Disabling the version storage is a practice to avoid the additional storage
overhead of versioning.  The reason for disabling the version storage is that
it is always used, even if no actual versions are stored.  So if an deployment
wants to avoid the storage overhead, and does not require document versioning,
the versioning can be disabled.
</p>

</subsection>

</section>

    </body>
</document>
